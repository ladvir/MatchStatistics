name: Deploy to Production (FTP)

on:
  push:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  check-secrets:
    runs-on: ubuntu-latest # Using linux for secret check is faster/more reliable
    environment: Production
    steps:
      - name: Check required secrets
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          if [ -z "$FTP_SERVER" ] || [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "❌ Missing core FTP secrets"
            exit 1
          fi
          echo "✅ Secrets verified"

  build-frontend:
    runs-on: windows-latest
    needs: check-secrets
    environment: Production
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install and Build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Verify Build Output
        shell: bash
        run: ls -R dist/ # This confirms the files actually exist before we upload

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/ # Ensure this matches your vite/webpack config output folder
          if-no-files-found: error # This will force the build to fail if dist is empty

  deploy-frontend:
    runs-on: windows-latest
    needs: build-frontend
    environment: Production
    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4 # Using v4 for maximum compatibility with upload v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: Prepare FTP Path
        id: fixpath
        shell: bash
        run: |
          path="${{ secrets.FTP_FRONTEND_PATH }}"
          if [ -z "$path" ]; then
            echo "FINAL_PATH=${{ secrets.FTP_SERVER_DIR }}" >> $GITHUB_ENV
          else
            # Ensure it ends with a slash
            [[ "$path" != */ ]] && path="$path/"
            echo "FINAL_PATH=$path" >> $GITHUB_ENV
          fi

      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./frontend-dist/
          server-dir: ${{ env.FINAL_PATH }}
          dangerous-clean-slate: true